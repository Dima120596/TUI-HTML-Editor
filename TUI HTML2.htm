<!-- saved from url=(0014)about:internet -->
<html lang=ru>
<head>
<style>
form {margin-bottom:0px;margin-left:0px;margin-right:0px;margin-top:0px;}
html,body {margin-bottom:0px; margin-left:0px; margin-right:0px; margin-top:0px;height:100%;}
	body 
	{
    -webkit-touch-callout: none; /* iOS Safari */
	-webkit-user-select: none; /* Safari */
	-khtml-user-select: none; /* Konqueror HTML */
    -moz-user-select: none; /* Firefox */
    -ms-user-select: none; /* Internet Explorer/Edge */
	-o-user-select:none; // opera
     user-select: none; /* Non-prefixed version, supported modern browser */                             	  
	 overflow: hidden;
	}
	
</style>
<title>Javascript TUI HTML Editor</title>
<!-- подключаем JavaScript-код, отвечающий за работу визуального HTML-редактора на веб-странице -->
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<script type="text/javascript">
U=window.navigator,atg=U.userAgent.toLowerCase();
_doc=document,win=window; //compact text args!!!
IE_DET=IE_DET=atg.indexOf('msie ')>-1 || atg.indexOf('trident/')>-1, magor=parseInt(U.appVersion,10);
iE_5_5=IE_DET&&(magor==4)&&(atg.indexOf('msie 5.5')!=-1);
iE_5_0=IE_DET&&(magor==4)&&(atg.indexOf('msie 5.0')!=-1);
iE_4_0=IE_DET&&(magor==4)&&(atg.indexOf('msie 5')==-1);
IE_NEW=!!(iE_5_5 || (!iE_5_5 && !iE_5_0 && !iE_4_0) || document.compatMode);
IE_OLD=(IE_NEW==false)&&(IE_DET==true);
Web2=atg.indexOf(".net clr")!=-1;
OldGecko=false,isWebkit=(atg.indexOf("webkit")>-1),OldDom=false; 
isGecko=(atg.indexOf("gecko")>-1)&&(isWebkit==false)&&(IE_DET==false); if (isGecko==true) { OldGecko=eval("typeof JSON=='undefined'"); }
isKHTML=(atg.indexOf('khtml')>-1)&&(isWebkit==false); //предок  webkit - checked!!!
OperaP=(atg.indexOf("opera")>-1)&&(isWebkit==false);
var iWin,iDoc,src_elm;
vlink="javascript:void(0)";
style_link='style="text-decoration:none;"';
	
//Table bases color:

// Фон текста!!!
hiliteColor = ((IE_DET || isWebkit || isKHTML)? "backcolor":"hiliteColor");

TB_Cansel=Tb('Cancel','canseled()'),src_end="</"+"script>",src_beg='<'+'script language="JavaScript" type="text/javascript">';
if (isKHTML) { fRange="\u200B\u200C\u200D\u2060\u2063\u200B\u200C"; fborder='';} 
else { fborder=" frameborder=1 ";} 

//formatBlock:
Tags_=["h1","h2","h3","h4","h5","h6","address","pre","div"];
Mt = "Monospace";
iHTML = "<html><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\"/></head><body contentEditable='true'>test</body></html>";
fspace='font-family:'+Mt+';';
marquee_s='',xmp_s=' style="'+fspace+'white-space:pre;',listing_s=xmp_s+'font-size:xx-small;"';xmp_s+='"';
nline="&nbsp;&nbsp;&nbsp;";
// ===== UNDO/REDO (Compact & Readable) =====
uBuf=[], uPos=1, uMax=20,u_len=0;


// Интерфейс встроенной системы: - (например 1С).
function GetFromEditor() { _doc.forms[1].codetext1.value=GetHTMDoc(); }

function SetTextFrom1C(T)
{   t="";
	t_ = _trim(t); if (t_==''||t_==12) {T_='<div>'+nline+t_+'</div>';} 
	else {T_ = eFHTM(T);} hDlg(T_);	
}

function uSave() 
{   
	uPos=uBuf.length; 
	uBuf[uPos]=iDoc.body.innerHTML; u_len=Math.min(u_len+1,uMax); if (u_len==uMax) {uBuf[0]=[]; uPos=uPos-1;}
}

function uUndo() { if (uMax<=0||u_len==0) { return; }
    prev=uPos-1; if(prev<0) return; 
    if(uBuf[prev]) {iDoc.body.innerHTML=uBuf[prev];uPos=prev;}
}

function uRedo() {
    next=uPos+1;
    if (uBuf[next]) { iDoc.body.innerHTML = uBuf[next]; uPos = next + 1; }
}

function GetHTMDoc() {return outerHTML(iDoc.documentElement||iDoc.body.parentElement,iDoc);}

function MakeEditor()
{
	//
	//Создание меню панелей:
	//
	var SA = [Tw("Text:"),["selectAll","Select page"],["justifyLeft","Left"],["justifyRight","Right"],["justifyCenter","Center"],
	["justifyFull","justify"],Tw("Outdent"),Tw("Indent"),["removeformat","Clear element"],
	["delete","Remove selection"], ["unlink","Remove link"]],SC=[Tw('Color'),['foreColor','Text color'],[hiliteColor,'Bgcolor text'],["bgcolor","Bgcolor page"]],
	Sfr = [["formatBlock","Block"]];
	
	for (i=0;i<Tags_.length;i++) { Sfr[i+1]=Tw(Tags_[i]); }
	i="attributes";
	var SEt = [["TblEdt","Table edit:"],["tBRw","+Row (up)"],["tARw","+Row (down)"],["tDRw","-Row"],["tBCl","+Col<-"],["tACl","+Col->"],["tDCl","-Col"],["tblM","Merge->"], 
    ["tblS","Split->"],["tblVM", "Merge (down)"], ["tblVS", "Split (down)"],["tblAtr",i]];
	var SM=[Tw("Main"),["Attr",i],["SrcB","body code"],["Src","HTML code"],['ClnAtr', 'Clean attributes and empty tags'],
    ['ClnOT','Clean Office and empty tags'],['Cln','Clean tags and attributes'],["EMT","Edit Meta/Title"],
    Tw("redo"),Tw("undo"),['And','Team undo'],['Ard','Team redo']];
	
	var SO =[["OTags","Other tags:"],Tw("blockquote"),Tw("samp"),Tw("code"),Tw("legend"),
	["del","Tag del (other strike]"],["SMALL","Tag small (small charaster"],["superscript","Tag sup (super script)"],
	["subscript","Tag sub (small script)"],["iHR","Horizontal Rul"],["insertParagraph","Enter key"],
	["listing","Tag listing"],["xmp", "Tag xmp"],["plaintext","plaintext (break html)"],["center","center (centering]"],["marquee","marquee string"]];
	
	var Sf = [["fontSize","Font Size:"],Tw("1"),Tw("2"),Tw("3"),Tw("4"),Tw("5"),Tw("6"),Tw("7")];	
	var Sft = [["fontName","Fonts:"],Tw("Arial"),Tw("Arial Black"),Tw("Comic Sans MS"),Tw("Courier New"),Tw("Helvetica")
				,Tw("Georgia"),Tw("Impact"),Tw("Times New Roman"),Tw("Trebuchet MS"),Tw("Verdana"),Tw("Webdings"),Tw(Mt)];	
    s='Marker';
	l='Number';
	var SL = [ ["LST", "Lists:"],["insertOrderedList","Order List"],["insertUnorderedList","Un order List"],   
	["Aln",'Line +'], //Добавление элемента списка!!!
	["Dln",'Line -'], //Удаление элемента списка!!!
    ["lIn", "+ Indent"],     // Увеличить отступ (создать вложенный список)
    ["lOt", "- Indent"],    // Уменьшить отступ (поднять на уровень)
    ["lstUL", "Set "+s],      // Сменить на маркированный список
    ["lstOL", "Set Number"],     // Сменить на нумерованный список
    ["lsD", s+" disc"],        // Маркер: черный круг (disc)
    ["lsC", s+" circle"],      // Маркер: белый круг (circle)
    ["lsS", s+" square"],      // Маркер: квадрат (square)
	["lsD", l+" 1"], // Нумерация: 1, 2, 3
	["lsA", l+" A"], // Нумерация: A, B, C
	["lsa", l+" a"], // Нумерация: a, b, c
    ["lsI", l+" I"], // Нумерация: I, II, III
    ["lsi", l+" i"]]; // Нумерация: i, ii, iii	  
	
	s="Anchor";i="anch";
	var SAh=[Tw(s),["h1"+i,s+" H1"],["h2"+i,s+" H2"],["h3"+i,s+" H3"],["h4"+i,s+" H4"],["h5"+i,s+" H5"],
	["h6"+i,s+" H6"],["fg"+i,s+" Figure"],["tb"+i,s+" Table"],["eq"+i,s+" Equation"],["is"+i,s+" Source"],
	["bk"+i,s+" Bookmark"],["ls"+i,s+" listing"]];	
	//Генерация массива ссылок на якоря!!!
	var SRA=[["hRef","Reference"]];
	for (i=1;i<SAh.length;i++) { SRA[i]=[SAh[i][0]+"ref","->"+SAh[i][1]]; }
	
	//OldDomBrowser - old KHTML/Safari 1.3 marker browsers!!!
	var S_;
	if (_doc.getElementById || IE_DET) { 	
		if (IE_DET==false)
		{ if(win.getSelection) { S_=win.getSelection();	if (!S_.getRangeAt) { OldDom=true;}}
	else { OldDom=true; }}} 
 	//Текстовая панель комманд:
	S_="<form method='POST' action='--WEBBOT-SELF--'>";
	S_+=_MSel(SM)+_MSel(SA)+_MSel(SL)+Tb('italic',"_EDT(this)")+Tb('bold',"_EDT(this)");
	S_+=Tb('strike',"_EDT(this)",'strikeThrough')+Tb('underline',"_EDT(this)");
	S_+=_MSel([["PM","Paste"],Tw("Image"),Tw("Link"),["I_f", "Frame (iframe/ilayer)"],Tw("table")]); //Paste-menu:
    //Write to Font-Size command: 	
	S_+=_MSel(SC)+_MSel(Sf)+_MSel(Sft)+_MSel(Sfr)+_MSel([["MSb","Symbols:"],Tw('Symbol'),Tw('Punct'),Tw('Math'),Tw('Strelok')]);		
	//OtherTags.  
	S_+=_MSel(SO)+_MSel(SAh)+_MSel(SRA)+_MSel(SEt);
    S_+="</form>";
	//Dialog Container!!!
	DSel=(_doc.getElementById && (OldDom==false || isKHTML==true))? '<iframe name="CDialog" id="CDialog" style="display: none;position: absolute;border:1px solid black; background-color: #FFFFFF;z-index:1000;"></iframe>':"";
	
    if (!_doc.designMode)
    {
        //Этот косяк как старых браузеров - так и ранних версий 1С - следовательно решать его придется другим путем - через свойство редактирования:
		_doc.write("<form><textarea name='codetext' rows="+20+" cols="+(_doc.width-5)+" >text edition not designMode not support</textarea>");
        _doc.write("</form>");
    }
    else
    {  
		//Режим поддерживается, следовательно создаем frame:		
		if (IE_DET && IE_NEW)
		{	// Баги внутри iframe 1C/IE - запрещено трогать - редактор учитывает анатомию и ошибки 1С 8.2 на всех версиях УФ!!!
			_doc.body.innerHTML= S_+"<iframe src='about:blank' id='frameId' style='border:1px solid black;' height='90%' width='100%' id='frameId' name='frameId' onload='lf(0)'></iframe><form method='POST' action='--WEBBOT-SELF--' name='HTML_CODE'></form>"+DSel;
	    }
		else 
		{ 
			_doc.write(S_+"<iframe src='about:blank' height='90%' style='border:1px solid black;' width='100%' "+fborder+" id='frameId' name='frameId'></iframe><form method='POST' action='--WEBBOT-SELF--' name='HTML_CODE'></form>"+DSel);				
			lf(1);
		}             
    }
}


function CreateWF(team,value,name)
{
    //Диалоговое окно iframe без геммороя!!!
	var dlg,doc,op_par,clsdw;
	//Tables element:
	t_right='<td align="right">',t_left='<td align="left">',t_span='td colspan=',f_beg='<form><table border="0" cellspacing="0" cellpadding=';
	//указатели:
	t="</td></tr>";
	s='</td><td>';
	f_end=t+'</table></form>'; 
	
	var Col_ = [
	["#FFFFCC","#FFFF99","#FFFF66","#FFFF33","#FFFF00","#CCCC00","#FFCC66","#FFCC00","#FFCC33","#CC9900","#CC9933","#996600","#FF9900","#FF9933","#CC9966","#CC6600","#996633","#663300"],
	["#FFCC99","#FF9966","#FF6600","#CC6633","#993300","#660000","#FF6633","#CC3300","#FF3300","#FF0000","#CC0000","#990000","#FFCCCC","#FF9999","#FF6666","#FF3333","#FF0033","#CC0033"],
	["#CC9999","#CC6666","#CC3333","#993333","#990033","#330000","#FF6699","#FF3366","#FF0066","#CC3366","#996666","#663333","#FF99CC","#FF3399","#FF0099","#CC0066","#993366","#660033"],
	["#FF66CC","#FF00CC","#FF33CC","#CC6699","#CC0099","#990066","#FFCCFF","#FF99FF","#FF66FF","#FF33FF","#FF00FF","#CC3399","#CC99CC","#CC66CC","#CC00CC","#CC33CC","#990099","#993399"],
	["#CC66FF","#CC33FF","#CC00FF","#9900CC","#996699","#660066","#CC99FF","#9933CC","#9933FF","#9900FF","#660099","#663366","#9966CC","#9966FF","#6600CC","#6633CC","#663399","#330033"],
	["#CCCCFF","#9999FF","#6633FF","#6600FF","#330099","#330066","#9999CC","#6666FF","#6666CC","#666699","#333399","#333366","#3333FF","#3300FF","#3300CC","#3333CC","#000099","#000066"],
	["#6699FF","#3366FF","#0000FF","#0000CC","#0033CC","#000033","#0066FF","#0066CC","#3366CC","#0033FF","#003399","#003366","#99CCFF","#3399FF","#0099FF","#6699CC","#336699","#006699"],
	["#66CCFF","#33CCFF","#00CCFF","#3399CC","#0099CC","#003333","#99CCCC","#66CCCC","#339999","#669999","#006666","#336666","#CCFFFF","#99FFFF","#66FFFF","#33FFFF","#00FFFF","#00CCCC"],
	["#99FFCC","#66FFCC","#33FFCC","#00FFCC","#33CCCC","#009999","#66CC99","#33CC99","#00CC99","#339966","#009966","#006633","#66FF99","#33FF99","#00FF99","#33CC66","#00CC66","#009933"],
	["#99FF99","#66FF66","#33FF66","#00FF66","#339933","#006600","#CCFFCC","#99CC99","#66CC66","#669966","#336633","#003300","#33FF33","#00FF33","#00FF00","#00CC00","#33CC33","#00CC33"],
	["#66FF00","#66FF33","#33FF00","#33CC00","#339900","#009900","#CCFF99","#99FF66","#66CC00","#66CC33","#669933","#336600","#99FF00","#99FF33","#99CC66","#99CC00","#99CC33","#669900"],
	["#CCFF66","#CCFF00","#CCFF33","#CCCC99","#666633","#333300","#CCCC66","#CCCC33","#999966","#999933","#999900","#666600","#FFFFFF","#CCCCCC","#999999","#666666","#333333","#000000"]]; 


//Specsymbol array:
var T_Symbol=[["&nbsp;","&ensp;","&emsp;","&hellip;","&#46;","&#44;","&#58;","&#59;","&#33;","&#63;","&iquest;","&#150;","&#8211;","&#8212;"],
                ["&quot;","&lsquo;","&rsquo;","&sbquo;","&ldquo;","&rdquo;","&bdquo;","&laquo;","&raquo;","&#40;","&#41;","&lang;","&rang;" ],
                ["&middot;","&#91;","&#93;","&#10075;","&#10076;","&#10077;","&#10078;","&#8481;","&#8507;","&trade;","&reg;","&copy;","&#9842;"],
                ["&#9851;","&#8984;","&cent;", "&#36;","&euro;","&pound;","&#8355;","&#8381;","&#8372;","&#8376;","&#22291;","&#8377;","&yen;"],
                ["&#3647;", "&#8383;", "&curren;"]];
//Math symbol:
var T_Math=[["&plusmn;","&frac14;","&frac12;","&frac34;","&times;","&divide;","&forall;","&part;","&exist;","&empty;","&nabla;"],  
 ["&isin;","&notin;","&ni;","&prod;","&sum;","&minus;","&lowast;","&radic;","&prop;","&infin;","&ang;","&and;","&or;"],  
 ["&cap;","&cup;","&int;","&there4;","&sim;","&cong;","&asymp;","&ne;","&equiv;","&le;","&ge;","&sub;","&sup;","&nsub;"],  
 ["&sube;","&supe;","&oplus;","&otimes;","&perp;","&sdot;"]];
//Table Strelok:
var T_Strelok=[["&larr;","&uarr;","&rarr;","&darr;","&harr;","&lArr;","&uArr;","&rArr;","&dArr;","&hArr;"]];
//Table punct znak: 
var T_Punct=[["&ndash;","&mdash;","&lsquo;","&rsquo;","&sbquo;","&ldquo;","&rdquo;","&bdquo;","&dagger;","&Dagger;"],
                ["&bull;","&hellip;","&permil;","&prime;","&Prime;","&lsaquo;","&rsaquo;","&oline;","&frasl;"]];
e='align="center"';
l='f=document.forms[0];';
	var S_table='function Add() { '+l ;
		S_table+='n_=(f.percent.value == "pixels") ? "" : "%";';
		S_table+='c2=(f.c.value == "") ? "":"<caption>"+f.c.value+"</caption>\\n";';
		S_table+='T_=(f.i.checked) ? "</tbody>":"";';
		S_table+='h="<table border=\\"" + f.br.value + "\\" cellpadding=\\"" + f.pad.value+"\\" ";';
		S_table+='h+= "cellspacing=\\"" + f.sp.value + "\\" width=\\"" + f.w.value+n_+"\\">\\n";';
		S_table+='h+= ""+c2;if (T_!="") {h+="<thead>\\n";for (rows = 0;rows<f.ccals.value;rows++) {';
		S_table+='h+= "<tr>\\n";for (col=0;col<f.cols.value;col++) {';
		S_table+='h+= "<td><b>&nbsp;</b></td>\\n";} h+= "</tr>\\n";} h += "</thead>\\n<tbody>\\n"; } ';
		S_table+='for (rows=0;rows<f.rows.value;rows++) {h+="<tr>\\n";';
		S_table+='for (col=0;col<f.cols.value;col++) {h+="<td>&nbsp;</td>\\n";} h+="</tr>\\n";}';
		S_table+='h+=T_+"</table>";call(h);} ';
							
		var F_table=f_beg+'"4"><tr>'+t_right+'caption</td><td colspan="3">';
		F_table+=Ti('c','','test')+t+t_right+'Input caption cals?</td>';
		F_table+='<'+t_span+'"2">'+Ti("ccals",'',"0")+t;
		F_table+='<td><input name="i" type="checkbox" value="test" onclick="'+l+'.ccals.value=(this.checked)? 1:0;"></td>';
		F_table+='<tr>'+t_right+'Rows'+s+Ti("rows","4","2")+'</td>'; 
		F_table+=t_left+'Columns: '+Ti("cols","4","2")+t+'<tr>';
		F_table+=t_right+'Table width'+s+Ti("w","4","100")+'</td>'+t_left;
		F_table+=MSel([Tw("percent"),Tw("pixels")])+t;
		F_table+='<tr>'+t_right+'Border thickness'+s+Ti("br","4","1")+'</td>';
		F_table+=t_left+'pixels'+t+'<tr>'+t_right+'Cell padding'+s+Ti("pad","4","4")+s;
		F_table+='Cell spacing: '+Ti("sp","4","0")+t;
		F_table+='<tr><'+t_span+'"3" '+e+'>'+Tb("Insert Table","Add();");
		F_table+=TB_Cansel+f_end;
		
		 //Form insert link: 
		var F_Link=f_beg+'"4">'; 
		F_Link+='<tr><'+t_span+'"2"><b>Tip:</b> To insert an email link, start your URL with "mailto:"'+t; 
		F_Link+='<tr>'+t_right+'URL:'+s+Ti("u","40","")+t; 	
		F_Link+='<tr>'+t_right+'Text:'+s+Ti("O","40","")+t;
		F_Link+='<tr>'+t_right+'Name:'+s+Ti("N","40","")+t;
		F_Link+='<tr>'+t_right+'Id:'+s+Ti("I","40","")+t;  
		F_Link+='<tr>'+t_right+'Target:</td>'+t_left+MSel([Tw("_blank"),Tw("_parent"),Tw("_self"),Tw("_top")]);	
		F_Link+=t+'<tr><'+t_span+'"3" '+e+'>'+Tb("Insert Link","Add()")+TB_Cansel+f_end;
		
		var S_Link='function Add() {'+l;
		S_Link+='id_=(f.I.value=="") ? "" :"id=\\""+f.I.value+"\\"";';
		S_Link+='n_=(f.N.value=="") ? "" :"name=\\""+f.N.value+"\\"";'; 
		S_Link+='h_=(f.u.value=="") ? "" :"href=\\""+f.u.value+"\\" ";';
		S_Link+='T_="TARGET=\\""+f._blank.value+"\\"";'; 
		S_Link+="S_='<a '+n_+' '+id_+' '+T_+' '+h_+'>'+f.O.value+'</a>';call(S_);}";
		//Form insert image: 
		var F_Image = '<center><h1>Insert Picture with attributes</h1></center>'+f_beg+'"4">';			
		F_Image+='<tr>'+t_right+'URL:</td><'+t_span+'"5">'+Ti("s","40")+t;
		F_Image+='<tr>'+t_right+'NAME:</td><'+t_span+'"5">'+Ti("NO","40")+t;
		F_Image+='<tr>'+t_right+'id:</td><'+t_span+'"5">'+Ti("IO","40")+t;
		F_Image+='<tr><td>Alt text:</td><'+t_span+'"5">'+Ti("Tx","40")+t;
		F_Image+='<tr><td>WIDTH:'+s+Ti("IW","4")+s+'HEIGHT:'+s+Ti("IH","4")+'</td>';
		F_Image+='<td>BORDER:'+s+Ti("IB","4")+t;
		F_Image+='<tr><'+t_span+'"6" '+e+'>'+Tb("Insert Image","Add()")+TB_Cansel+f_end;
		
		var S_Image = 'function Add(){'+l;
		S_Image+='h_ = ""; if (f.s.value != "") { h_ = " src=\\"" + f.s.value + "\\"";}';
		S_Image+='n_ = ""; if (f.NO.value != "") { n_ = " name=\\"" + f.NO.value + "\\"";}';
		S_Image+='i_="";if (f.IO.value != "") { i_ = " id=\\"" + f.IO.value + "\\"";}';
		S_Image+='T_="";if (f.Tx.value != "") {T_ = " alt=\\"" + f.Tx.value + "\\"";}';
		S_Image+='W_="";if (f.IW.value != "") {W_=" width=\\"" + f.IW.value + "\\"";    }';
		S_Image+='H_ ="";if (f.IH.value!="") {H_=" height=\\"" + f.IH.value + "\\""; }';
		S_Image+='B_ ="";if (f.IB.value!="") {B_=" border=\\"" + f.IB.value + "\\""; }';
		S_Image+='S_="<img"+n_+i_+h_+W_+H_+B_+T_+">";call(S_);}';
		// IFRAME/ILAYER
		s=MSel([Tw("px"),Tw("%")],'');
		
		_id="about:blank";
		var F_I_f=f_beg+'"2">';
		F_I_f+='<tr>'+t_right+'SRC:'+s+Ti("url","30",i)+t;
		F_I_f+='<tr>'+t_right+'ID:'+s+Ti("I","30")+t;
		F_I_f+='<tr>'+t_right+'NAME:'+s+Ti("N","30")+t;
		F_I_f+='<tr>'+t_right+'WIDTH:'+s+Ti("w","8","300")+s+t;
		F_I_f+='<tr>'+t_right+'HEIGHT:'+s+Ti("V","8","200");
		F_I_f+=s.replace('name="px"','name="px1"')+t;
		F_I_f+='<tr>'+t_right+'FRAMEBORDER:'+s+Ti("fbr","10","1")+t;
		F_I_f+='<tr><'+t_span+'"2" '+e+'><small>px = pixels, % = percent of container</small>'+t;
		F_I_f+='<tr><'+t_span+'"2" '+e+'>'+Tb("Insert Frame","Add()")+TB_Cansel+f_end;

		var S_I_f ='function Add() {'+l;
		S_I_f+='s_=f.url.value ? \' src="\'+f.url.value+\'"\':\'\';';
		S_I_f+='i_=f.I.value ? \' id="\' +f.I.value + \'"\' : \'\';';
		S_I_f+='_=f.N.value ? \' name="\'+f.N.value+\'"\':\'\';w_=f.w.value;';
		S_I_f+='wt=f.px.value;wh_=w_ ? \' width="\' +w_+wt+ \'"\':\'\';h_val=f.V.value;';
		S_I_f+='ht_=h_val ? \' height="\'+h_val+f.px1.value+\'"\':\'\';';
		S_I_f+='fbr_=f.fbr.value ? \' style="border:\'+f.fbr.value+\'px solid black;"\':\'\';'; 
		S_I_f+='h=\'<iframe\'+s_+i_ +_ +wh_+ht_+fbr_+\'>\';';
		S_I_f+='h+=\'<ilayer\'+s_+i_ + n_+wh_+ht_+ \'>\';';
		S_I_f+='h+=\'<p>See <a href="\'+(f.url.value || \'#\')+\'">content</a>.</p>\';';
		S_I_f+='h+=\'</ilayer>\'; h+= \'</iframe>\';call(h);}';	
				
		
    if (_doc.getElementById && (OldDom==false||isKHTML==true)&&(Web2==false))
    {
	    doc = win.frames["CDialog"].document; //Universal get frames document
        i=_doc.getElementById("CDialog").style;		
		//Clean opened iframe!!!
		if (i.display = "block") i.zIndex="1000";
		i.width="300px";i.height="400px"; i.top="10px"; 
		i.display = "block"; 
	    h=win.pageXOffset||_doc.body.scrollLeft||0; 
        i.left=h+((win.innerWidth||_doc.body.clientWidth)-320)/ 2+"px"; 
		op_par="window.parent";clsdw=op_par+".ICls(12);";	
    }
    else
    {
        dlg = win.open(((isWebkit||isKHTML)?"":_id),"","width=300,height=300"); 
		doc = dlg.document;
		dlg.focus();clsdw="window.close();";	op_par="window.opener";
    }
	// Callback function for forms:
	s='function call(h){';
	t='function canseled(){'+clsdw+'}';
	var cb=s+op_par+'.TextTags("p","",h+"<br/>_after_<br/>");'+clsdw+'}'+t;
	var cbMeta=s+op_par+'.ICls(h);'+clsdw+'}'+t;
	//Создание панелей выбора (цвета,ссылок и прочего например):
	doc.open(); s='title';
	doc.write('<html><head><'+s+'>'+value+'</'+s+'></head><body>'+value+'<br>');
	//Редактор атрибутов...
	if (team=="Attr")
	{	
		//IE 4.0 не работает нормально с атрибутами - 
		h=(IE_OLD)?['id','name','class','border','src','with','height','href','target','alt','style','cellpadding', 'cellspacing']:src_elm[value]; //attributes
		doc.write(f_beg+'"2">');
		for(i=0;i<h.length;i++)
		{ 
		  t=(IE_OLD)?h[i]:h[i].name;
		  s=src_elm.getAttribute(t);
		  e='tr><td>';
		  if (_trim(s)!='') { doc.write('<'+e+t+'</'+e+Ti('_'+t,20,eFHTM(s))); }
		}
		s=' function Add() {'+l+' for(i=0;i<f.length;i++) {d=f[i]; '+op_par+'.SetAt(d.name.substring(1),'+op_par+'._trim(d.value));canseled();}}';//+
		doc.write(f_end+"<form>"+Tb("Apply","Add()")+TB_Cansel+"</form>"+src_beg+s+cb+src_end+'</body></html>');
	}
	
	if(team=='bgcolor'||team=='foreColor'||team==hiliteColor)
	{
		CreateTBDoc(doc,Col_,op_par,clsdw,team);			
	}
	
	if(team=='Symbol'|| team=='Strelok'|| team=='Punct'||team=='Math')
    {   //Сжатый функционал создания таблицы/Картинки!!!		
	   CreateTBDoc(doc, eval("T_"+team), op_par, clsdw, team); 
	}
	if (team=='table'||team=='Image'||team=='Link'||team=='I_f')
	{	
		doc.write(eval("F_"+team)+src_beg+eval("S_"+team)+cb+src_end+'</body></html>');
	}
	//Reference module!!!
	if (team=='hRef')
	{ 	var _Ref=[["hR","Reference"]],C=iDoc.all?iDoc.all.tags("A"):iDoc.getElementsByTagName("a");
		_t='';
		t=name;
		e=_Ref.length;
		t=t.substring(0,6);
		for (i=0;i<C.length;i++)
		{  l=C[i];s=l.name;s=s.substring(0,6);
		   if(s==t) 
		   { _t='';
			 if (l.innerText) {_t=l.innerText;} else { _t=l.innerHTML;_t=_t.replace(/<[^>]+>/g,'');}
             if (_t=='') {_t=l.name;} _Ref[e]=[l.name,_t];e+=1;}
		}
		if (_Ref.length > 1) { doc.write('<br/><form>'+MSel(_Ref,'')+'<br/><br/>'+Tb("OK","Add()")); }
		else{ doc.write('<p>No anchors: '+t+'</p>'); }
		doc.write(TB_Cansel+'</form>'+src_beg+'function Add(){');
		doc.write('f=document.forms[0].hR;h=f.selectedIndex;if(h <= 0) return;');
		doc.write('_a="Ref "+f[h].text;h=\'<a href="#\' + f.value + \'">\'+_a+\'</a>\';call(h);}');	
		doc.write(cb.replace('"p"','""')+src_end+'</body></html>');
	}
	if(team=='Src'||team=='SrcB') { 
	    doc.write('<form>'+Tb("OK","call(document.forms[0].e.value)")+TB_Cansel); 
        doc.write('<br/><textarea name="e" rows="30" cols="30" style="width: 90%; height:90%;">'+(team=="Src"?GetHTMDoc():iDoc.body.innerHTML)+'</textarea>');
		doc.write('</form>'+src_beg+(team=='Src'?cbMeta:cbMeta.replace("ICls(h)","iDoc.body.innerHTML=h"))+src_end+'</body></html>');	
	}

	if (team=='EMT') {
		
		_t='utf-8';
		var t=iDoc.title||'',i,m,d='',k='',a='',c=_t,f,S_M_TA,ms=iDoc.all?iDoc.all.tags("META"):iDoc.getElementsByTagName("meta");  
		t="</td></tr>";
		s='</td><td>';
		l="description";
		_ln="keywords";
		ti="author";
		S_M_TA='function Add() {f=document.forms[0];h='+op_par+'.updMT(f.tle.value||"",f.char_.value,f.d.value||"",f.k.value||"",f.ah.value||"");';
		S_M_TA+='call(h);}';
        for(i=0;i<ms.length;i++){
            m=ms[i],n=m.getAttribute("name")||'',ct=m.getAttribute("content")||'',n=n.toLowerCase();
            if(n==l)d=ct;
            else if(n==_ln)k=ct;
            else if(n==ti)a=ct;
            ch=m.getAttribute("charset");if(ch)c=ch;
            eq=m.getAttribute("http-equiv")||'';
            if(eq.toLowerCase()=="content-type"){ cm=ct.match(/charset\s*=\s*([^;]+)/i); if(cm&&cm[1])c=_trim(cm[1]);} }
	
		i=MSel([Tw("utf-8"),Tw("windows-1251"),Tw("koi8-r"),Tw("iso-8859-5")],'');
	
		f=f_beg+'"2"><tr><'+t_span+'"2" align="center"><b>Edit Document HEAD</b>'+t;
		f+='<tr>'+t_right+'Title:'+s+Ti("tle","40",_id)+t;
		f+='<tr>'+t_right+'Charset:'+s+i.replace('name="'+_t+'"','name="char_"')+t;
		f+='<tr>'+t_right+l+':'+s+Ti("d","40",eFHTM(d))+t;
		f+='<tr>'+t_right+_ln+':'+s+Ti("k","40",eFHTM(k))+t;
		f+='<tr>'+t_right+ti+':'+s+Ti("ah","40",eFHTM(a))+t;
		f+='<tr><'+t_span+'"2"><small>Leave empty to remove meta tag</small>'+t;
		f+='<tr><'+t_span+'"2" align="center">'+Tb("Apply","Add()")+TB_Cansel+f_end;
		d='selected';a='select';
        s=f.indexOf('<'+a+' name="charset"');
		i=f.indexOf('</'+a+'>',s);
        s=f.substring(s,i); s=s.replace('value="utf-8" '+d,'value="utf-8"');
        l='value="'+c.toLowerCase()+'"',pos=s.indexOf(l);
        if(pos!=-1)f=f.substring(0,s)+s.substring(0,pos+l.length)+' '+d+s.substring(pos+l.length)+f.substring(i);
        doc.write(f+src_beg+S_M_TA+cbMeta+src_end+'</body></html>');
	}
	doc.close();
}

function SetAt(d,v,e) { if(e){} else {e=src_elm;}  if (v=="") {e.removeAttribute(d);} else {e.setAttribute(d,v);} }


function CreateTBDoc(D,C_,op_par,cdw,team) 
{
	D.write('<form><table cellpadding="0" cellspacing="1" border="1"><tbody>');
	for (j=0; j<C_.length; j++) {
		D.write('<tr>');
		for (i=0; i<C_[j].length; i++)
		{   s=C_[j][i];  
			if(team=='bgcolor'||team=='foreColor'||team==hiliteColor) 
			{	D.write('<td bgcolor='+"'"+s+"'"+' width="3" height="3">');	 				
				D.write('<a '+style_link+' href='+vlink+' onclick="'+op_par+'.EditCmd('+"'"+team+"'"+','+"'"+s+"'"+');'+cdw+'"'+' >');		   		   
				D.write('<font size="3" color="'+s+'">'+nline+'</font>');		   
				D.write('</a></td>'); 
			}
			else {  D.write('<td>'+Tb(s,op_par+'.TextTags(\'\',\'\',this.value);'+cdw)+'</td>'); }
		}
        D.write('</tr>'); }
	D.write('</tbody></table>'+TB_Cansel+'</form>');
}

//Table editor:
// ===== ГЛОБАЛЬНЫЕ ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ДЛЯ ТАБЛИЦ=====
function tblCellAt(r, ci) {
    var idx = 0, cell, sp,k;
    for (k = 0; k < r.cells.length; k++) {
        cell = r.cells[k]; sp = cell.colSpan || 1;
        if (ci >= idx && ci < idx + sp) return {c: cell, p: k, s: sp};
        idx += sp;
    }
    return null;
}

function tblCanDelRow(t, ri) {
    var cr = t.rows[ri], i, r, c, cell, sr, er;
    for (i = 0; i < cr.cells.length; i++) { if (cr.cells[i].rowSpan > 1) return false; }
    for (r = 0; r < t.rows.length; r++) {
        if (r == ri) continue;
        for (c = 0; c < t.rows[r].cells.length; c++) {
            cell = t.rows[r].cells[c];
            if (cell.rowSpan > 1 && (sr = r) <= ri && ri <= (er = sr + cell.rowSpan - 1)) return false;
        }
    }
    return true;
}

function tblCanDelCol(t, r, ci) {
    var lci = 0, i, rr, cr, cl, ccs, cs, lp;
    for (i = 0; i < ci; i++) lci += r.cells[i].colSpan || 1;
    for (rr = 0; rr < t.rows.length; rr++) {
        cr = t.rows[rr], lp = 0;
        for (c = 0; c < cr.cells.length; c++) {
            cl = cr.cells[c], ccs = cl.colSpan || 1;
            cs = lp;
            if (lci >= cs && lci < cs + ccs) {
                if (ccs > 1) return false;
                break; }
            lp += ccs;
        }
    }
    return true;
}

function tblWarn(msg) { alert("Attention: " + msg); }


// ===== ОСНОВНАЯ ФУНКЦИЯ РЕДАКТОРА =====
function _TblEdt(cmd,value) {
	//alert(value);
	src_elm=gPTag(src_elm,'TD');
	if(!src_elm) { tblWarn("Not select cell"); return;}
    var r = gP(src_elm), t = r, i = 0,ri = 0, ci = 0, rs, cs, lci, info, nR, fR, c, nc, n, tR, rr, j; 
	t=gPTag(r,'TABLE');
    if (!t) return;
    while (ri < t.rows.length && t.rows[ri] != r) ri++;
    while (ci < r.cells.length && r.cells[ci] != src_elm) ci++;  
    rs = src_elm.rowSpan || 1; cs = src_elm.colSpan || 1;
    if (cmd =="tblAtr")
	{
	  src_elm=t;
	  CreateWF("Attr",value,cmd);
	}
    else if (cmd=="tARw"||cmd=="tBRw") {
        if (rs > 1) return;
		fR = t.rows[ri];
		nR = t.insertRow(cmd=="tBRw"? ri:ri+1);
        for (i = 0; i < fR.cells.length; i++) {
            c = fR.cells[i], nc = nR.insertCell(i); nc.innerHTML = "&nbsp;";
            if (c.colSpan > 1) nc.colSpan = c.colSpan;
        }
    }
    else if (cmd == "tDRw") {
        if (t.rows.length <= 1) return;
        if (!tblCanDelRow(t, ri)) {
            tblWarn("Can't delete a row with merged cells");
            return;
        }
        t.deleteRow(ri);
    }
    else if (cmd =="tACl"||cmd=="tBCl") {
        lci = 0;
        for (i = 0; i < ci; i++) lci += r.cells[i].colSpan || 1;
        for (i = 0; i < t.rows.length; i++) {
            rr = t.rows[i], info = tblCellAt(rr, lci);
            if (info) {
                if (info.s > 1) info.c.colSpan++;
                else {
				    //колонки
                    nc = rr.insertCell(cmd=="tBCl"? info.p:info.p+1);
                    nc.innerHTML = "&nbsp;";
                    if (info.c.rowSpan > 1) nc.rowSpan = info.c.rowSpan;
                }
            }
        }
    }
    else if (cmd == "tDCl") {
        if (!tblCanDelCol(t, r, ci)) {
            tblWarn("Can't delete a column with merged cells");
            return;
        }
        lci = 0;
        for (i = 0;i<ci;i++) lci += r.cells[i].colSpan || 1;
        for (i=0;i<t.rows.length;i++) {
            rr = t.rows[i], info = tblCellAt(rr, lci);
            if (info) {
                if (info.s > 1) {
                    info.c.colSpan--;
                    if (info.s - 1 == 1) SetAt('colSpan',null,info.c);//info.c.removeAttribute('colSpan');
                }
                else rr.deleteCell(info.p);
            }
        }
    }
    else if (cmd == "tblM") {
        if (ci >= r.cells.length - 1) return;
        n = r.cells[ci + 1];
        if (!n || rs != (n.rowSpan || 1)) return;
        src_elm.colSpan = cs + (n.colSpan || 1);
        src_elm.innerHTML += " " + n.innerHTML;
        r.deleteCell(ci + 1);
    }
    else if (cmd == "tblS") {
        if (cs <= 1) return;
        src_elm.colSpan = 1;
        for (i = 1; i < cs; i++) {
            nc = r.insertCell(ci + i);
            nc.innerHTML = "&nbsp;";
            if (rs > 1) nc.rowSpan = rs;
        }
    }
    else if (cmd == "tblVM") {
        if (ri >= t.rows.length - 1) return;
        nR = t.rows[ri + 1], info = tblCellAt(nR, ci);
        if (!info || cs != (info.c.colSpan || 1)) return;
        src_elm.rowSpan = rs + (info.c.rowSpan || 1);
        src_elm.innerHTML += "<br>" + info.c.innerHTML;
        nR.deleteCell(info.p);
    }
    else if (cmd == "tblVS") {
        if (rs <= 1) return;
        src_elm.rowSpan = 1;
        for (i = 1; i < rs; i++) {
            tR = t.rows[ri + i];
            if (tR) {
                nc = tR.insertCell(ci);
                nc.innerHTML = "&nbsp;";
                if (cs > 1) nc.colSpan = cs;
            }
        }
    }
	
	uSave();
}

function ICls(h)
{
	if (h!=12) { 
	d=iDoc;
	// Извлекаем title из текста если есть
	s_='_t="";t=h.match(/<title[^>]*>([^<]*)<\\/title>/gi);if(t&&t[1]){_t=_trim(t[1]);}iDoc.title=_t;'; 
    if ((IE_DET &&IE_NEW) || (isWebkit && OldDom)|| OldGecko) { 
        if (d.body==null) { lf(0, h); } 
		else {
            // Полная очистка body перед вставкой
            b = d.body; while (b.firstChild) { b.removeChild(b.firstChild); }
            if(IE_DET) {d.write(h);}
			else { //Old safari/khtml - don't like to rewrite!!!
                t = h,t = t.replace(/<\/?html[^>]*>/gi, "").replace(/<head[^>]*>/gi, "").replace(/<\/head>/gi, "");
				b.innerHTML = t.replace(/<title[^>]*>[\s\S]*<\/title>/gi, "").replace(/<body[^>]*>/gi, "").replace(/<\/body>/gi, "");  }
            // Полный список тегов, которые могут быть в head
            hTags = ["title","meta","link","style","script","base","noscript","basefont","bgsound","object","embed"];
            // Собираем все элементы из body
            idx = b.getElementsByTagName('*'); 
            
			eval(s_);
			t=d.getElementsByTagName("head")[0];
			while (t.firstChild) { t.removeChild(t.firstChild);}
			d.title = _t;
            // Обрабатываем элементы body
            for (i = 0; i < id.length; i++) {
                e = idx[i];
                if (!e || !e.tagName || !e.parentNode) continue;
                if (hTags[e.tagName.toLowerCase()]) { // Пропускаем если не head-тег
                t.appendChild(e); }
            }
        } }
    else { lf(1, h); if(IE_DET==false) { eval(s_);} }
	}

	if (_doc.getElementById && (OldDom==false||isKHTML==true)) 
	{
		var doc = window.frames["CDialog"].document; //Universal get frames document
		doc.open(); doc.close(); //Rewrite other browsers!!!
		t = document.getElementById("CDialog").style; t.width = "0px"; t.height = "0px"; t.top = "0px"; t.display = "none";
		if (OldGecko==false)  {t.zIndex = "0";}      
    }		
}

//Test tags - used to special command:
function TextTags(tag1,style,STR_)
{   
	iWin.focus(); 
	uSave(); 
	STR=STR_;
    //var ci,rang,sel,arr_;	
    if (IE_DET && iDoc.selection) 
	{ 
		rang = iDoc.selection.createRange();
		if (typeof STR_=='undefined') { STR=rang.text; }
		iDoc.selection.clear(); //Очищаем выделение:
		ci=(tag1==""?STR:"<"+tag1+">"+STR+""+'</'+tag1+'>');
		rang.pasteHTML(ci);
		uSave(); return 0;}
     if (win.getSelection) { 
		sel=iWin.getSelection();  
		if (typeof STR_=='undefined') { STR=String(sel); } 
        //Selection for old Webkit/khtml!!!  
		STR=(tag1==""?STR:("<"+tag1+">"+STR+""+'</'+tag1+'>'));
		if (IE_DET || OldDom || OldGecko || OperaP) //IE-11 fix and old version safari and khtml!!!
        {	 
			//Clear selections !!!
			if (String(sel)!="") { iDoc.execCommand(OldDom?'insertText':'delete','',''); } 
			sel=iWin.getSelection(); //Update descriptor!!!
            if (sel.getRangeAt) { rang = sel.getRangeAt(0);}
			else  { rang = iDoc.createRange(); rang.setStart(sel.anchorNode,sel.anchorOffset); rang.setEnd(sel.focusNode,sel.focusOffset); }
			ci=iDoc.createElement("SPAN");
			ci.innerHTML=STR;		  
			rang.insertNode(ci);                                               
			sel=gP(ci); 
			while (ci.firstChild) { sel.insertBefore(ci.firstChild, ci); } 
			sel.removeChild(ci); 
		}	
        else 
		{	
			iDoc.execCommand('insertHTML', '',STR); 
		}
		uSave(); return 0; }		
	if (iDoc.getSelection) {
		if (typeof STR_=='undefined') { STR=String(iDoc.getSelection()); } 		
		if (iDoc.execCommand('insertText', false, fRange))
		{
			sel=iDoc.body.childNodes; 
			for (j=0;j<sel.length;j++) {
				rang=sel[j];
				t_=rang.textContent||rang.innerText;
				if (t_.indexOf(fRange)>-1) 
				{	if (rang.nodeType==3) {rang=rang.parentNode} //Node_TEXT_NODE=3
				rang.innerHTML=rang.innerHTML.replace(fRange,(tag1==""? STR:"<"+tag1+">"+STR+""+'</'+tag1+'>'));
				break;
				}
			} 
		}
	}
	uSave();
	
 }
 
 //Fix safari errors!!!
function mc(e) {e1=e||iWin.event;src_elm=e1.target||e1.srcElement; if(OldDom) { if (src_elm.nodeType==3) src_elm=src_elm.parentNode;}}
 
function _EDT(a){	
	n=((a.name=='')?a.value:a.name),arg="",idx=-1;
	   if (a.selectedIndex) { 
			idx=a.selectedIndex;  
            a.selectedIndex=0;
            if(n=="formatBlock"||n=="fontName"||n=='fontSize'||n=="hRef"){ arg=a.options[idx].value; team=n; }
            else{ team=a.options[idx].value;}
			t_=a.options[idx].text;
        }else{ team=n; }
		
		if (team == "And") { uUndo(); return 0; }
		if (team == "Ard") { uRedo(); return 0; }		  
		//Панели!!!  
		if (n=="Color"||n=="MSb"||n=='PM'||n=="hRef"||team=="Src"||team=='EMT'||team=="SrcB"||team=="Attr")  {CreateWF(team,t_,arg);return 0; }
		
		//Работа со списками - придется вставить внутрь - иначе лимит на процедуры IE 4!!!
		if (n=="LST")
		{	
		  if (idx>2) 	//team!="insertOrderedList" && team!="insertUnorderedList"
		  {
		   //Первый этап - вычисляем родителя списка:
			src_elm=gPTag(src_elm,'LI');
			if (!src_elm) return 0; 
			s=gP(src_elm); t='';
			if (!s) return 0;
			t=s.tagName.toUpperCase();
			if (t!='UL' && t!='OL') return 0;
						
			if (team=='Aln')
			{ 
				if (IE_OLD) { src_elm.outerHTML = src_elm.outerHTML+'<LI>&nbsp;</LI>';  }
				else
				{	
					i=iDoc.createElement('li');
					i.innerHTML='&nbsp;';
					s.insertBefore(i, src_elm.nextSibling);
					s.innerHTML = s.innerHTML;
				}					
				return 0;
			}
			if (team=='Dln')
			{
				if (IE_OLD) { if (s.children.length > 1) src_elm.outerHTML ='';  }
				else { if (s.childNodes.length>0) { s.removeChild(src_elm); s.innerHTML = s.innerHTML; } }
				return 0;				
			}
			i=t_.substring(0,6);
            //Все проверили, значит устанавливаем тип маркера!!!			
			if ((i=="Marker" && t=='UL') || (i=="Number" && t=='OL')) { s.type=t_.substring(7);s.innerHTML = s.innerHTML; return 0;}
			i=t_.substring(0,1);
			if (i=="+"||i=="-") 
			{	//Change indent!!!
				if (i=="+")
				{   // Создаем вложенный список: <ul><li>[текущий элемент]</li></ul>
				    if (IE_OLD) 
					{   //Textrange лучше, но места нет - так что через OuterHTML!!!
						src_elm.outerHTML = ((s.children.length == 1)? '<li>uplevel</li>':'')+'<'+t+'>'+src_elm.outerHTML+'</'+t+'>';
					}
					else 
					{   //OuterHTML не везде есть - так что работаем через DOM интерфейс!!!
                        if (s.firstChild==src_elm)  
						{	n = iDoc.createElement('li'); 
							n.innerHTML="uplevel";
						    s.insertBefore(n, s.firstChild);	
						}						
					    n=iDoc.createElement(t);
						s.insertBefore(n, src_elm);
						n.appendChild(src_elm);
					}
				}
				else
				{
				   h=gP(s); //Верхний уровень найден!!!
				   if (!h) return 0;
				   n=s.children;
				   if (IE_OLD)
				   {
				     if (n.length == 1) { s.outerHTML=src_elm.outerHTML }
					  else
					  {
					     //
						 //разрезаем элемент на 2 части - до нашего героя и после!!!
						 h='',id='',j=false;
						 for (i=0;i<n.length;i++) 
						 {  
						    t_=n[i];
						    if (src_elm==t_) { j=true; continue;} 
						    if (j==false) { h+=t_.outerHTML; }
							else { id+=t_.outerHTML; }
						 }
						 //ну а теперь просто начинаем поэтапно вставлять элементы!!!
						 n=src_elm.outerHTML; //Выбрать тэг целиком!!!
						 if (id!='') { n+='<'+t+'>'+id+'</'+t+'>';}
						 s.insertAdjacentHTML('afterEnd', n);
						 if (h=='') { s.outerHTML="";  } else {  s.innerHTML=h; }
					  } 
				   }
				   else
				   {
					   h.insertBefore(src_elm, s);
					   if (s.childNodes.length==0) { h.removeChild(s); }
					   h.innerHTML=h.innerHTML;
				   }
				}
				
			}
			else
			{	//replace lists tags!!!
				i=team.substring(3);
				if (i==t) { return 0;}
				if (IE_OLD) {  s.outerHTML='<'+i+'>'+s.innerHTML+'</'+i+'>'; } //IE 4.0 -5.0x
				else 
				{       id=iDoc.createElement(i); 
						id.innerHTML=s.innerHTML; 
						idx=gP(s); 
						//Replace child сломано - используем комбинацию методов!!!
						idx.insertBefore(id,s);
						idx.removeChild(s);
				}
			}
			return 0;
		  }
		}
		if(n=="TblEdt") { _TblEdt(team,t_);return 0; }
        // Commands don't need panel
		if (team=="marquee" || team=="listing" || team=="xmp" ) {
		 t=(team+"_str ")+gSTxt()||'';
		 t ='<p'+eval(team+"_s")+'><'+team+eval(team+"_s")+'>'+t+'</'+team+'></p><br/>_after';TextTags('p','',t);return 0;
		}
        if((n=='OTags')&&!(team=="iHR"||team=='PARAGRATH')){ TextTags(team);return 0; }
		if (team=="iHR") {  TextTags('p','','<p><hr></p></br>_after');return 0;} //Горизонтальная линия теперь лучше!!!
		
        // Cleaner office tags!!!
        if(team=='ClnAtr'){ClsHTM(1);return 0;}
        if(team=='ClnOT'){ClsHTM(2);return 0;}
        if(team=='Cln'){ClsHTM(3);return 0;}
		if (n=="Anchor") {  
			i=team.substring(0,2); _t=i; //кэшируем первые 2 символа команды, этого уже хватит для семейства якорей!!!
			s = Math.floor(Math.random()*65536);
			t = gSTxt()||"object_"+s;id='<a name="'+team+'_'+s+'">'; //t - указатель, а s - содержимое!!!
            if (!Tags_[i.substring(1,2)]) i="div";
			if (_t=='bk') h= id+t+'</a>';  //Произвольный якорь (Bookmark)!!!
			else
			{
			  h = '<'+i+'>'+id; 
			  if (i!='div') h+=t+'</a>'; //Шаблон заголовков h1-h6 - текст внутри ссылки!!!
			  else 
			  {  h+='</a>'; //Для всех остальных, которые типизированы - закладка через другую схему - стили оформления внутри span!!!
			   if(_t=='fg') { s_="font-size:smaller;font-style:italic;"; t='Picture. '+t; } //
				else if(_t=='eq') { s_=fspace; t='Formula. ('+t+')'; }
				else if (_t=='tb') { s_="font-weight:bold;"; t='Table. ('+t+')';   } 
				 else if (_t=='is') { s_=fspace+'background:#f0f0f0;'; t='Listing. '+t;  }
			    h+='<span style="'+s_+'">'+t+'</span>';
			  }
			  h+='</'+i+'>';
			
			}
			TextTags('','',h+'&nbsp;_after');return 0; 
		}
        
        EditCmd(team,arg);
}

function EditCmd(team,arg)
{	
		s_=""; //color
		uSave();
		_t=OperaP?'insertHTML':'insertText';
		if (OldDom || isKHTML) //old emulator;
		{ 		
			if (team=="strikeThrough") { TextTags("s"); team=""; }
			//Basicaly support for old webkit/khtml web browsers!!!
			if (team=="formatBlock") { TextTags(arg,'',gSTxt()); team=""; }	
			//Basical support List appended!!!
			if (n=="LST") 
			{   
				_t=(idx==1?"ol":"ul");
				t = gSTxt(); 
				if (t=='') return 0;
				h='';		
				s = t.split(/\r?\n/);
				for (s_ = 0; s_ < s.length; s_++) {
					id = _trim(s[s_]);
					if (id != "") h += "<li>" + id + "</li>"; 
				}
				if (h!='') { TextTags("", "",'<'+_t+'>'+h+'</'+_t+'>'); }
				team="";
			}
			
			/* <absolute-size> values - for Webkit correct fonts values old safari browsers in design mode */
			s_=[0,'xx-small','x-small','small','medium','large','x-large','xx-large'];
			if (team=="underline") { TextTags("u"); team=""; } if (team=="fontSize") {arg=s_[arg];}	
		}
		//Replace selections to old Safari and KHTML web browsers!!!
	    if (team=="removeformat"||team=="unlink" && (OldDom || isKHTML || OperaP)) { iDoc.execCommand(_t, '',gSTxt());team="" }		
		if (team=="formatBlock") { arg="<"+arg+">"; } 		
		//fixed bug command to reset background color to different browser:
		if(team=='bgcolor') { iDoc.bgcolor=arg; iDoc.body.style.background=arg;  team="";}
		//fixed bug command to reset background color to different browser:
		if (team==hiliteColor || team=="removeformat"||team=="unlink") { s_ = iDoc.bgcolor; s_ = iDoc.body.style.background; }
		//repair color page (bug browser command):
		if (team!="") 
		{	iWin.focus();iDoc.execCommand(team, '', arg); 
			if (s_!="")  {iDoc.bgcolor=s_; iDoc.body.style.background=s_; }			
		}	
		uSave();
        return 0;     
}


//
//Work to get HTML document!!!
//

function updMT(t,c,d,k,a){
    iDoc.title=t;
    if(document.getElementById&&OldGecko==false){ //DOM 1
		_t='content'; id='name';
		s_='h.removeChild(m);i--;'; //быстрый код - замена функции через eval
        h=iDoc.getElementsByTagName('head')[0];
        if(!h)return;
        var ms=h.getElementsByTagName('meta'),fd=0,fk=0,fa=0,fc=0,i,m,n,eq,ch,ct,nct;
        for(i=0;i<ms.length;i++){
            m=ms[i];n=m.getAttribute('name')||'';eq=m.getAttribute('http-equiv')||'';ch=m.getAttribute('charset');
			b=n.toLowerCase();
            if(b=='description'){fd=1;if(d) SetAt(_t,d,m);else{eval(s_);}}
            else if(b=='keywords'){fk=1;if(k) SetAt(_t,k,m);else{eval(s_);}}
            else if(b=='author'){fa=1;if(a) SetAt(_t,a,m);else{eval(s_);}}
            else if(ch){fc=1;if(c) SetAt('charset',c,m);else{eval(s_);}}
            else if(eq.toLowerCase()=='content-type'){
                fc=1;
                if(c){ct=m.getAttribute(_t)||'';nct=ct.replace(/charset\s*=\s*[^;]+/i,'charset='+c);
                if(nct==ct)nct=ct+'; charset='+c;m.setAttribute(_t,nct);}
                else{h.removeChild(m);i--;}
            }
        }
		s_="iDoc.createElement('meta')"; t='h.appendChild(m)'; //быстрый код - замена функции через eval
		if(d&&!fd){m=eval(s_);SetAt(id,'description',m);SetAt(_t,d,m);eval(t);}
		if(k&&!fk){m=eval(s_);SetAt(id,'keywords',m);SetAt(_t,k,m);eval(t);}
		if(a&&!fa){m=eval(s_);SetAt(id,'author',m);SetAt(_t,a,m);eval(t);}
		if(c&&!fc){m=eval(s_);SetAt('charset',c,m);eval(t);}		
		return 12; //
    } //Остался IE 4:
	else
	{ return GetMTDoc(t,c,d,k,a); }
}

function GetMTDoc(t,c,d,k,a){
    var doc=iDoc,h="<HEAD>\n", head="",cs=c;
    if(t)h+="<TITLE>"+(t||'')+"</TITLE>\n";
    else if(doc.title)h+="<TITLE>"+doc.title+"</TITLE>\n"; // Charset
	if (OldGecko) {head=doc.getElementsByTagName('head')[0];}
    if(c!=null){
        cs=doc.charset||doc.characterSet||doc.defaultCharset||"utf-8";
		ms =(IE_DET)? doc.all.tags('META'):head.getElementsByTagName('meta'); 
        for(i=0;i<ms.length;i++){
            m=ms[i],mc=m.getAttribute('charset');
            if(mc){cs=mc;break;}
            eq=m.httpEquiv||m.getAttribute('http-equiv')||'';
            if(eq.toLowerCase()=='content-type'){
                ct=m.content||m.getAttribute('content')||'',mt=ct.match(/charset\s*=\s*([^;]+)/i);
                if(mt&&mt[1]){cs=_trim(mt[1]);break;}
            }
        }
    }
    h+='<META http-equiv="Content-Type" content="text/html; charset='+(cs||"utf-8")+'">\n';
    // Остальные теги
    tg=['META','BASE','LINK','SCRIPT','STYLE'];
    for(ti=0;ti<tg.length;ti++){
		els =(IE_DET)? doc.all.tags(tg[ti]):doc.getElementsByTagName(tg[ti].toLowerCase());
		for(i=0;i<els.length;i++){
            el=els[i]; prt =(IE_DET)? el.parentElement:head;
            if(prt.tagName.toLowerCase()=="head"){
                tgn=tg[ti].toLowerCase();
				if(tgn=='meta'){
                    n=el.name||el.getAttribute('name')||'',
                        eq=el.httpEquiv||el.getAttribute('http-equiv')||'';
                    if((n=='description'&&d!=null)||(n=='keywords'&&k!=null)||
                       (n=='author'&&a!=null)||eq.toLowerCase()=='content-type'|| el.getAttribute('charset'))continue;}
                h+='<'+tg[ti];
                if(el.name)h+=' name="'+el.name+'"';
                if(el.httpEquiv)h+=' http-equiv="'+el.httpEquiv+'"';
                if(el.content)h+=' content="'+el.content+'"';
                if(el.href)h+=' href="'+el.href+'"';
                if(el.src)h+=' src="'+el.src+'"';
                if(el.rel)h+=' rel="'+el.rel+'"';
                if(el.target)h+=' target="'+el.target+'"';
                if(tgn=='script' || tgn=='style'){
                    h+='>';
                    if((tgn=='script')&&el.text)h+=el.text;
                    if((tgn=='style')&&el.styleSheet&&el.styleSheet.cssText)h+=el.styleSheet.cssText;
                    else if(el.innerHTML)h+=el.innerHTML;
                    h+='</'+tg[ti]+'>';
                }else h+='>';
                h+='\n';
            }
        }
    }
    // Новые meta
    if(d)h+='<META name="description" content="'+d+''+'">\n'; 
    if(k)h+='<META name="keywords" content="'+k+'">\n';
    if(a)h+='<META name="author" content="'+a+'">\n';
    h+="</HEAD>";
    return "<HTML>\n"+h+"\n"+outerHTML(doc.body)+"\n</HTML>"; 
}

// Protez DHTML for old gecko and opera browser:
function outerHTML(e,d){
   tagName=e.tagName.toLowerCase();
    u=(!IE_DET||IE_NEW)?!!e.outerHTML:(IE_DET&&tagName=="html")?0:!!e.outerHTML;
    if(u&& tagName!="html" )return e.outerHTML;
	itg=""; 
	if(u) { itg = e.outerHTML; }
	else if (IE_DET==true && IE_NEW==false) {itg=GetMTDoc(null,null,null,null,null);}
    else {	
		 ret = "<" + e.tagName;
            if (e.attributes && e.attributes.length) {
			for (i = 0; i < e.attributes.length; i++) {  attr=e.attributes[i];
                    if (attr && attr.name && attr.nodeValue != null) { ret+=" "+attr.name+'="'+attr.nodeValue+'"'; }}
            }
           ret += ">"; if (e.innerHTML) {ret+=e.innerHTML;} ret+="</"+e.tagName+">";
		   itg = ret;
		}
	if (tagName=="html")
	{   b = itg.substring(1,5);
       if (b=="html" || isGecko) { if (itg.indexOf('</title') == -1) {itg=itg.replace('<head>','<head><title>'+d.title +'</title>');}}	   
	   if (b=="HTML") { if (itg.indexOf('</TITLE')==-1) {itg=itg.replace('<HEAD>','<HEAD><TITLE>'+d.title +'</TITLE>');}}
	}
	return itg;
}

function lf(t,h) {	
  
  if (!h) h=iHTML;
  //Возможности против версий для определения доступов к iframe!!!
  iframe = frames["frameId"];
  iWin = (iframe.contentWindow) ? iframe.contentWindow : iframe.window;
  iDoc = (iframe.contentDocument) ? iframe.contentDocument : iframe.document;
  
  if (t==1) { iDoc.open();iDoc.write(h);iDoc.close(); }
  else  { iDoc.write(h); }
  src_elm = iDoc.body; 
  S=(OperaP||OldDom)?"mousedown":'click';
  if (iDoc.addEventListener) iDoc.addEventListener(S,function(event) {mc(event)},false); 
  else {setTimeout("iDoc.onmousedown=mc;", 100); }	//bugs fix onload IE 4.01 !!!
  uBuf[0]=iDoc.body.innerHTML;u_len=1;
  iDoc.designMode = (isGecko) ? "on":"On";  
  
}


// ============ УНИВЕРСАЛЬНАЯ ФУНКЦИЯ ОЧИСТКИ HTML ============
function ClsHTM(m) {
// Список Office/outlook тегов для удаления
offT=['o:p','o:smarttagtype','st1:','![if','![endif]','text:', 'draw:','office:','w:','v:shape','v:imagedata',
'meta[name="Generator"]','meta[name="ProgId"]','meta[http-equiv="Content-Type"]','o:SmartTagType','v:shapetype','v:stroke',
'v:path','xml:namespace','style[type="text/css"]','v:rect','v:roundrect','v:oval','v:line','w:WordDocument','w:LatentStyles',
'w:LsdException','v:group','v:background','v:shadow','v:textbox','mso-ignore:','urn:schemas-microsoft-com:'];
// Атрибуты Office/outlook и атрибуты с датами (Chrome добавляет)
Atrs=['class="Mso', 'style="[^"]*mso-','lang="','o:title="','v:ext="','o:gfxdata="','face="','wname="','o:spid="','data-time="','data-timestamp="','data-created="','data-modified="',
'style="margin:0"','class="MsoNormal"','lang="','face="','size="','color="','v:text-anchor="','o:spid="','o:spt="'];
sTag=['br','hr','img','input','meta','link','base','area','col','param'];
offM=['mso','Mso','office','if','endif','w:','st1:','o:','vmlframe','WordDocument','LatentStyles','vmlframe','urn:schemas-'];	
   var h = iDoc.body.innerHTML, o = h, r = "", i, p, t,e,a,f;
    // 1. Удаление офис тегов
    if (m == 2 || m == 3) {
        for (i = 0; i < offT.length; i++) { t = offT[i]; p = 0;
            while ((p = h.indexOf('<' + t, p)) != -1) { e=h.indexOf('>', p); if (e == -1) break; h = h.substring(0, p) + h.substring(e + 1); }
            p = 0;
            while ((p = h.indexOf('</' + t, p)) != -1) { e=h.indexOf('>', p); if (e == -1) break; h = h.substring(0, p) + h.substring(e + 1);}
        }
    }
    // 2. Удаление атрибутов
    if (m == 1 || m == 3) {
        for (i = 0; i < Atrs.length; i++) {
            a = Atrs[i]; p = 0;
            while (p < h.length) {
                aP = h.indexOf(a, p); if (aP == -1) break; f = h.lastIndexOf('<', aP), tEnd = h.indexOf('>', aP);
				if (f == -1 || tEnd == -1 || f > aP) { p = aP + 1; continue; }
                qEnd = h.indexOf('"', aP + a.length); if (qEnd == -1 || qEnd > tEnd) { p = aP + 1; continue; }
				b = h.substring(0, aP), af = h.substring(qEnd + 1);
                if (b.charAt(b.length - 1) == ' ') b = b.substring(0, b.length - 1); h = b + af; p = f;
            }
        }
    }
    
    // 3. Удаление пустых тегов
    p = 0; r = "";
    while (p < h.length) {
        if (h.charAt(p) == '<' && p + 1 < h.length && h.charAt(p + 1) != '!' && h.charAt(p + 1) != '?') {
            ts = p, te = h.indexOf('>', p); if (te == -1) { r += h.charAt(p); p++; continue; }
            tc = h.substring(p + 1, te), tn = "", j = 0;
            while (j < tc.length && tc.charAt(j) != ' ' && tc.charAt(j) != '/' && tc.charAt(j) != '>') 
                tn += tc.charAt(j++);
            tn = tn.toLowerCase();
            sc = false;
            for (j = 0; j < sTag.length; j++) if (tn == sTag[j]) { sc = true; break; }
            if (tc.charAt(tc.length - 1) == '/') sc = true;
            if (!sc) {
                ct = '</' + tn + '>', nc = h.indexOf(ct, te + 1);
                if (nc != -1) {
                    cnt = h.substring(te + 1, nc), ept = true;
                    for (c = 0; c < cnt.length; c++) {
                        ch = cnt.charAt(c);
                        if (ch != ' ' && ch != '\t' && ch != '\n' && ch != '\r' && ch != '\f' && ch != '\v') {
                            if (ch == '&' && cnt.substring(c, c + 6) == '&nbsp;') { c += 5; continue; }
                            ept = false; break;
                        }
                    }
                    if (ept) { p = nc + ct.length; continue; }
                }
            }
            r += h.substring(ts, te + 1); p = te + 1;
        } else { r += h.charAt(p); p++; }
    }
    h = r;
    // 4. Удаление офис комментариев
    if (m == 2 || m == 3) {
        p = 0; r = "";
        while (p < h.length) {
            if (h.substr(p, 4) == '<!-'+'-') {
                ce = h.indexOf('--'+'>', p + 4); if (ce == -1) { r += h.charAt(p); p++; continue; }
                cmt = h.substring(p + 4, ce), f = false; //isOffice
                for (m = 0; m < offM.length; m++) 
                    if (cmt.indexOf(offM[m]) != -1) { f = true; break; }
                if (f) { p = ce + 3; continue; }
                else { r += h.substring(p, ce + 3); p = ce + 3; }
            } else { r += h.charAt(p); p++; }
        }
        h = r;
    }
    // Применение результата
    if (h != o) { 
        iDoc.body.innerHTML=h; uSave();
        alert('Clean finish');
    } else { 
        alert('Not find cahanges'); 
    }
}

if (IE_DET && IE_NEW) { window.onload=MakeEditor; } else { MakeEditor();}
// ============ ГЕНЕРАЦИЯ ЭЛЕМЕНТОВ ФОРМЫ HTML/Cлужебные фукнции ============
function Tb(v,o,n) {return '<input type="button" value="'+v+'" OnClick="'+o+'"'+(_trim(n)==''?'':(' name="'+n+'"'))+'/>';}	
// Текстовое поле (без type, всегда text)
function Ti(nam,siz,val){ return '<input type="text"'+(_trim(nam)==''?'':(' name="'+nam+'"'))+(_trim(siz)==''?'':(' size="'+siz+'"'))+(_trim(val)==''?'':(' value="'+val+'"'))+'/>'; }
//Select с общим обработчиком
function MSel(Sel,OnCh) {S="";len=Sel.length-1;
	for (i=0;i<=len;i++) { h=Sel[i]; if (i==0) { S+='<select name="'+h[0]+'" size="1" '+OnCh+'>';}
		S+='<option value="'+h[0]+'">'+h[1]+'</option>'; if (i==len) { S+='</select>'; }}
	return S; }
//Создание списка HTML для главного меню с обработчиками!!!

function _MSel(e) {   return MSel(e,"onchange='if(this.selectedIndex>0) { _EDT(this);} return 0;'"); }

function gSTxt() { if (iDoc.selection) {return iDoc.selection.createRange().text;} 
	else {return String((win.getSelection)? iWin.getSelection():iDoc.getSelection());}}

function _trim(s){
    if (s) {if(s=='')return'';} else {return '';}
	var r='',c=false,t='',ch;
    for(i=0;i<s.length;i++){
        ch=s.charAt(i);
        if(ch==' '||ch=='\t'||ch=='\n'||ch=='\r'||ch=='\f'||ch=='\v'){
            if(c)t=t+ch;
        }else{
            if(!c)c=true;
            if(t){r=r+t;t='';} r=r+ch;}
    }
    return r; }
//Универсальное получение родителя элемента!!!
function gP(i) { return i.parentElement||i.parentNode; }

//Родительский элемент внутри body!!!
function gPTag(El, tTag, mD) {
    var i,f,el = El,n=mD||5,_t=tTag.toUpperCase();	
    for (i = 0; i<n;i++) {
        if (!el||!el.tagName) break;
        f = el.tagName.toUpperCase(); //Верхний регистр сразу!!!		
        if (f == _t) { return el;} // Проверяем текущий элемент
        if (f == 'BODY' || f == 'HTML' || f == 'TABLE') { return null; } // Стоп-сигналы: если упёрлись в эти теги, дальше искать бессмысленно
        el = gP(el);
    }
    return null;
}

function eFHTM(t) { if (!t) return ''; var r = '',ch;
    for (i=0;i<t.length;i++) {
        ch=t.charAt(i);
        if (ch=='"') r += '&quot;';
        else if (ch=='<') r+='&lt;';
        else if (ch=='>') r+='&gt;';
        else if (ch=='&') r+='&amp;'; 
        else r+=ch;}
    return r;}
//Возврат массива из значения
function Tw(v) {return [v,v];}

</script>
</head>
<body>

</body>
</html>
